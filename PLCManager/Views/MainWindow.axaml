<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:PLCManager.ViewModels"
        xmlns:converters="using:PLCManager.Converters"
        x:Class="PLCManager.Views.MainWindow"
        x:DataType="vm:MainWindowViewModel"
        Title="Nodus/IP"
        Width="370"
        Height="650"
        Background="#36393F"
        Icon="/Assets/icon.ico"
        ExtendClientAreaToDecorationsHint="True"
        ExtendClientAreaChromeHints="NoChrome"
        ExtendClientAreaTitleBarHeightHint="35">

    <Window.Resources>
        <converters:IsEqualConverter x:Key="IsEqualConverter"/>
    </Window.Resources>

    <DockPanel>
        <!-- Custom Title Bar -->
        <Border DockPanel.Dock="Top" Background="#5865F2" Height="35" PointerPressed="OnTitleBarPointerPressed">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="80"/>
                </Grid.ColumnDefinitions>

                <TextBlock Grid.Column="0"
                          Text="⚡ NODUS/IP"
                          FontSize="14"
                          FontWeight="Bold"
                          Foreground="White"
                          VerticalAlignment="Center"
                          HorizontalAlignment="Left"
                          Margin="12,0,0,0"/>

                <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="0">
                    <Button Content="—"
                            Click="OnMinimizeClick"
                            Background="Transparent"
                            Foreground="White"
                            BorderThickness="0"
                            Width="40"
                            Height="35"
                            FontSize="16"
                            Padding="0,-5,0,0"
                            VerticalContentAlignment="Center"
                            HorizontalContentAlignment="Center">
                        <Button.Styles>
                            <Style Selector="Button:pointerover">
                                <Setter Property="Background" Value="#4752C4"/>
                            </Style>
                        </Button.Styles>
                    </Button>
                    <Button Content="✕"
                            Click="OnCloseClick"
                            Background="Transparent"
                            Foreground="White"
                            BorderThickness="0"
                            Width="40"
                            Height="35"
                            FontSize="16"
                            VerticalContentAlignment="Center"
                            HorizontalContentAlignment="Center">
                        <Button.Styles>
                            <Style Selector="Button:pointerover">
                                <Setter Property="Background" Value="#ED4245"/>
                            </Style>
                        </Button.Styles>
                    </Button>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Search Box -->
        <Border DockPanel.Dock="Top" Background="#202225" Padding="10,8">
            <TextBox Text="{Binding SearchText}"
                    Background="#40444B"
                    Foreground="White"
                    BorderThickness="0"
                    Padding="10,6"
                    FontSize="12"
                    Watermark="🔍 Search connections..."/>
        </Border>

        <!-- Top Toolbar with Action Buttons -->
        <Border DockPanel.Dock="Top" Background="#202225" Padding="10,8,10,10">
            <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Center">
                <Button Content="🔄"
                        Command="{Binding OpenUpdateUrlCommand}"
                        Background="#FAA81A"
                        Foreground="White"
                        Padding="10,6"
                        FontSize="16"
                        ToolTip.Tip="Update available - click to download"
                        IsVisible="{Binding UpdateAvailable}">
                    <Button.Styles>
                        <Style Selector="Button:pointerover">
                            <Setter Property="Background" Value="#E09615"/>
                        </Style>
                    </Button.Styles>
                </Button>
                <Button Content="+"
                        Click="OnAddNewClick"
                        Background="#40444B"
                        Foreground="White"
                        Padding="12,6"
                        FontSize="18"
                        FontWeight="Bold"
                        ToolTip.Tip="Add new PLC">
                    <Button.Styles>
                        <Style Selector="Button:pointerover">
                            <Setter Property="Background" Value="#5865F2"/>
                        </Style>
                    </Button.Styles>
                </Button>
                <Button Content="-"
                        Command="{Binding DeleteCommand}"
                        CommandParameter="{Binding SelectedConnection}"
                        Background="#40444B"
                        Foreground="White"
                        Padding="14,6"
                        FontSize="18"
                        FontWeight="Bold"
                        ToolTip.Tip="Delete selected PLC"
                        IsEnabled="{Binding SelectedConnection, Converter={x:Static ObjectConverters.IsNotNull}}">
                    <Button.Styles>
                        <Style Selector="Button:pointerover">
                            <Setter Property="Background" Value="#5865F2"/>
                        </Style>
                    </Button.Styles>
                </Button>
                <Button Content="📡"
                        Command="{Binding PingCommand}"
                        CommandParameter="{Binding SelectedConnection}"
                        Background="#40444B"
                        Foreground="White"
                        Padding="10,6"
                        FontSize="16"
                        ToolTip.Tip="Ping selected PLC"
                        IsEnabled="{Binding SelectedConnection, Converter={x:Static ObjectConverters.IsNotNull}}">
                    <Button.Styles>
                        <Style Selector="Button:pointerover">
                            <Setter Property="Background" Value="#5865F2"/>
                        </Style>
                    </Button.Styles>
                </Button>
                <Button Content="🔗"
                        Command="{Binding ConnectCommand}"
                        CommandParameter="{Binding SelectedConnection}"
                        Background="#40444B"
                        Foreground="White"
                        Padding="10,6"
                        FontSize="16"
                        ToolTip.Tip="Set IP for selected PLC"
                        IsEnabled="{Binding SelectedConnection, Converter={x:Static ObjectConverters.IsNotNull}}">
                    <Button.Styles>
                        <Style Selector="Button:pointerover">
                            <Setter Property="Background" Value="#5865F2"/>
                        </Style>
                    </Button.Styles>
                </Button>
                <Button Content="💾"
                        Click="OnSaveClick"
                        Background="#40444B"
                        Foreground="White"
                        Padding="10,6"
                        FontSize="16"
                        ToolTip.Tip="Save PLC list">
                    <Button.Styles>
                        <Style Selector="Button:pointerover">
                            <Setter Property="Background" Value="#5865F2"/>
                        </Style>
                    </Button.Styles>
                </Button>
                <Button Content="📂"
                        Click="OnLoadClick"
                        Background="#40444B"
                        Foreground="White"
                        Padding="10,6"
                        FontSize="16"
                        ToolTip.Tip="Load PLC list">
                    <Button.Styles>
                        <Style Selector="Button:pointerover">
                            <Setter Property="Background" Value="#5865F2"/>
                        </Style>
                    </Button.Styles>
                </Button>
            </StackPanel>
        </Border>

        <!-- Status Bar -->
        <Border DockPanel.Dock="Bottom" Padding="8">
            <Border.Background>
                <SolidColorBrush Color="{Binding UpdateAvailable, Converter={x:Static ObjectConverters.IsNotNull}, FallbackValue=#5865F2}"/>
            </Border.Background>
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <TextBlock Grid.Column="0" Text="{Binding StatusMessage}" Foreground="White" FontSize="12"/>
                <TextBlock Grid.Column="1"
                          Text="{Binding UpdateAvailable, Converter={x:Static ObjectConverters.IsNotNull}, FallbackValue=''}"
                          Foreground="White"
                          FontSize="10"
                          VerticalAlignment="Center"
                          IsVisible="False"/>
            </Grid>
        </Border>

        <!-- Sidebar with Collapsible Buildings -->
        <Border Background="#2F3136">
            <ScrollViewer>
                <ItemsControl ItemsSource="{Binding GroupedConnections}">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Expander IsExpanded="True" Margin="0,5,0,0">
                                <Expander.Header>
                                    <TextBlock Text="{Binding BuildingName}"
                                              FontSize="13"
                                              FontWeight="Bold"
                                              Foreground="#FAA81A"
                                              VerticalAlignment="Center"/>
                                </Expander.Header>
                                <Expander.Styles>
                                    <Style Selector="Expander">
                                        <Setter Property="Background" Value="#202225"/>
                                        <Setter Property="HorizontalAlignment" Value="Stretch"/>
                                    </Style>
                                    <Style Selector="Expander /template/ ToggleButton">
                                        <Setter Property="Background" Value="#202225"/>
                                        <Setter Property="Padding" Value="12,8"/>
                                    </Style>
                                    <Style Selector="Expander /template/ ToggleButton:pointerover">
                                        <Setter Property="Background" Value="#40444B"/>
                                    </Style>
                                    <Style Selector="Expander /template/ ContentPresenter#PART_Content">
                                        <Setter Property="HorizontalAlignment" Value="Stretch"/>
                                    </Style>
                                </Expander.Styles>

                                <!-- Connections in this building -->
                                <ItemsControl ItemsSource="{Binding Connections}" Background="#2F3136" HorizontalAlignment="Stretch">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Border BorderThickness="0,0,0,1" BorderBrush="#202225">
                                                <Border.Background>
                                                    <SolidColorBrush Color="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).SelectedConnection, Converter={x:Static ObjectConverters.IsNotNull}, FallbackValue=#2F3136}"/>
                                                </Border.Background>
                                                <Grid HorizontalAlignment="Stretch">
                                                    <Button Name="ItemButton"
                                                           Background="Transparent"
                                                           BorderThickness="0"
                                                           HorizontalAlignment="Stretch"
                                                           HorizontalContentAlignment="Left"
                                                           Command="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).SelectConnectionCommand}"
                                                           CommandParameter="{Binding}"
                                                           Padding="20,10,50,10"
                                                           DoubleTapped="OnConnectionDoubleClick"
                                                           Loaded="OnItemLoaded">
                                                        <Button.Styles>
                                                            <Style Selector="Button:pointerover">
                                                                <Setter Property="Background" Value="#40444B"/>
                                                            </Style>
                                                        </Button.Styles>
                                                        <StackPanel HorizontalAlignment="Stretch">
                                                            <TextBlock Text="{Binding Name}"
                                                                      FontSize="13"
                                                                      FontWeight="SemiBold"
                                                                      Foreground="White"/>
                                                            <TextBlock Text="{Binding PlcIpAddress}"
                                                                      FontSize="10"
                                                                      Foreground="#B9BBBE"
                                                                      Margin="0,3,0,0"/>
                                                        </StackPanel>
                                                    </Button>

                                                    <!-- Connect button - only visible when this item is selected -->
                                                    <Button Content="🔗"
                                                            Command="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).ConnectCommand}"
                                                            CommandParameter="{Binding}"
                                                            Background="#5865F2"
                                                            Foreground="White"
                                                            BorderThickness="0"
                                                            Width="35"
                                                            Height="35"
                                                            FontSize="14"
                                                            HorizontalAlignment="Right"
                                                            VerticalAlignment="Center"
                                                            Margin="0,0,8,0"
                                                            ToolTip.Tip="Set IP for this PLC">
                                                        <Button.IsVisible>
                                                            <MultiBinding Converter="{StaticResource IsEqualConverter}">
                                                                <Binding Path="."/>
                                                                <Binding Path="$parent[Window].((vm:MainWindowViewModel)DataContext).SelectedConnection"/>
                                                            </MultiBinding>
                                                        </Button.IsVisible>
                                                        <Button.Styles>
                                                            <Style Selector="Button:pointerover">
                                                                <Setter Property="Background" Value="#4752C4"/>
                                                            </Style>
                                                        </Button.Styles>
                                                    </Button>
                                                </Grid>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </Expander>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </ScrollViewer>
        </Border>
    </DockPanel>
</Window>
